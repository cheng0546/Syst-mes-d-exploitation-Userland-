/* 
 * Auteur(s): ZHEN Cheng
 */

#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>
#include <string.h>

//void (*sig_avant)(int);		/* pour la question 4.3 */
struct sigaction sig_avant;

void hdl_sys1(int n) {
  printf("hdl_sys1: Signal recu: %d\n", n);

}


void travail() {
  /* Je travaille tres intensement !    */
  /* Ne cherchez pas a comprendre ;-) */
  /* Il n'y a rien a modifier ici     */
  const char msg[] = "-\\|/";
  const int sz = strlen(msg);
  int i = 0;

  for (;;) {
    write(STDOUT_FILENO, "\r", 1);
    usleep(100000);
    write(STDOUT_FILENO, " => ", 4);
    write(STDOUT_FILENO, &msg[i++], 1);
    if (i == sz) i = 0;
  }
}
void travail() __attribute__((noreturn));
/* Petit raffinement pour le compilateur: cette fonction ne termine pas */

void signalHandlerINT1(int num) {  /* Handler pour le signal INT 1 */
	printf("Received message 1\n");
}
void signalHandlerINT2(int num) {  /* Handler pour le signal INT 2 */
	printf("Received message 2\n");
}
void signalHandlerQUIT(int num) {  /* Handler pour le signal QUIT */
	sigaction(SIGINT, &sig_avant, &sig_avant);
}

void signalHandler(int num) {
	printf("Caught the signal %d\n", num);
	exit(1);
}

int main() {
  printf("PID: %d\n", getpid());
  
  struct sigaction sig_INT1, sig_INT2, sig_QUIT;
  
  sig_INT1.sa_handler = signalHandlerINT1;
  sig_INT2.sa_handler = signalHandlerINT2;
  sig_QUIT.sa_handler = signalHandlerQUIT;
  sig_avant = sig_INT2;  /* Initialisation du sigaction 'sig_avant' */
  
  sigaction(SIGINT, &sig_INT1, NULL);  /* Reception de signal par Ctrl-C et execution de 'signalHandlerINT1()' */
  sigaction(SIGQUIT, &sig_QUIT, NULL);  /* Reception de signal par Ctrl-\ et execution de 'signalHandlerQUIT()' */
  signal(SIGILL, signalHandler); /* Reception de signal par un kill et execution de 'signalHandler()' */
  
  travail();
}
