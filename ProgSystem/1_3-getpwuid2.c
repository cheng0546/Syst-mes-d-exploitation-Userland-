/*
 * Auteur(s): ZHEN Cheng
 *
 * Cet programme refait ce que fait la commande "ls". Il donne des
 * informnations sur les caracteristiques de fichiers dont le nom est passe
 * en parametre.
 *
 * Utilisation de la primitive stat(2) et de la fonction getpwuid(3).
 */

#include <sys/types.h>
#include <sys/stat.h>
#include <pwd.h>
#include <stdio.h>
#include <stdlib.h>

/* Petite fonction qui se charge d'envoyer les messages d'erreur
   et qui ensuite "suicide" le processus. */

void erreur_grave(char *msg) {
  perror(msg);
  exit(EXIT_FAILURE);
}

/* Fonction principale (fournie avec erreur(s?)) */

int main(int argc, char *argv[]) {
  struct stat status, *buffer;
  buffer = &status;
  int r;
  
  r = stat(argv[0], buffer);
  // printf("%d", r);
  if (r < 0)
    erreur_grave("Stat");
    
  struct passwd *passwd[2];
  passwd[0] = getpwuid(buffer->st_uid);
  printf("first get passwd1: %d\n", passwd[0] -> pw_uid);
  passwd[1] = getpwuid(100);
  printf("second get passwd2: %d\n", passwd[1] -> pw_uid);

  printf("Fichier %s:  mode: %X  Taille: %ld  Proprietaire: %d\n",
	argv[0], buffer->st_mode, buffer->st_size, passwd[0]->pw_uid);
	
	printf("Fichier %s:  mode: %X  Taille: %ld  Proprietaire: %d\n",
	argv[0], buffer->st_mode, buffer->st_size, passwd[1]->pw_uid);
	
	
/* Problème : lors qu'on refait un appel à getpwuid(), 
   le retour du deuxième getpwuid() indique le même endroit que le retour du première, 
   donc sur les deux affichages on voit les même résultats. */

  exit(EXIT_SUCCESS);
}

