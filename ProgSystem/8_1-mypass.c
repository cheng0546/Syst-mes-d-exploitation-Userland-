/* 
 * Auteur(s): ZHEN Cheng
 */

#include <sys/time.h>
#include <stdio.h>
#include <termios.h>
#include <stdlib.h>
#define _XOPEN_SOURCE	/* Voir le man 3 crypt */
#include <unistd.h>
#include <crypt.h>
#include <errno.h>
#define ECHOFLAGS (ECHO | ECHOE | ECHOK | ECHONL)
#define BUFSIZE 64

char *c_key =
    "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789./";

char getkey() {
  long nb;
  struct timeval tp;
  
  if(gettimeofday(&tp, NULL) == 0) {   /* Recuperation de temps reel */
  	srandom(tp.tv_sec + tp.tv_usec);  /* Mettre une graine pour prendre un resultat aleatoire */
  	nb = random() % 64;
  	return c_key[nb ];  /* Recuperation d'une cle par le resultat aleatoire */
  } else {
  	exit(EXIT_FAILURE);
  }
}

int setsilent(struct termios *initial_term) {
  int err;
  struct termios term;
  if(tcgetattr(STDIN_FILENO, &term) == -1) {
		perror("Error: cannot get the attribution");
		return 1;
  }
  term.c_lflag &=~ECHOFLAGS;
  err = tcsetattr(STDIN_FILENO, TCSAFLUSH, &term);
  if(err == -1 && err == EINTR) {
  	perror("Error: cannot set the attribution");
  	return 1;
  }

  return 0;
}

int restaure_term(struct termios *initial_term) {
  int err;
  struct termios term;
  if(tcgetattr(STDIN_FILENO, &term) == -1) {
  	perror("Error: cannot get the attribution");
  	return 1;
  }
  term.c_lflag |=ECHOFLAGS;
  err = tcsetattr(STDIN_FILENO, TCSAFLUSH, &term);
  if(err == -1 && err == EINTR) {
  	perror("Error: cannot set the attribution");
  	return 1;
  }
  return 0;
}

/*  a utiliser au 8.4 */
char *get_pass() {
  static char buf[BUFSIZE];
  char c;
  int i = 0;

  while ((c = getchar()) != '\n') {
    buf[i++] = c;
    putchar('*');
  }

  buf[i] = '\0';
  putchar('\n');
  
  return buf;
}


int main() {
  int r;
  char buf[BUFSIZE], *s, *pwd;
  char salt[2];
  
  struct termios initial_term;

	salt[0] = getkey();
	salt[1] = getkey();
  printf("key = %s\n", salt);

  printf("Tapez votre mot de passe : ");
  setsilent(&initial_term);
  
  get_pass();  /* Recuperation de buffer */
  s = fgets(buf, BUFSIZE, stdin);

	pwd = crypt(s, salt); /* chiffrement de mot de pass par le salt */
  printf("Mot de passe chiffre : %s\n", pwd);
  
  restaure_term(&initial_term);
  exit(EXIT_SUCCESS);
}
